package goat.projectLinearity;

import com.fren_gor.ultimateAdvancementAPI.AdvancementTab;
import goat.projectLinearity.commands.GetAllConsegrityAdvancementsCommand;
import goat.projectLinearity.commands.RegenerateCommand;
import goat.projectLinearity.commands.WarptoCommand;
import goat.projectLinearity.structure.StructureListener;
import goat.projectLinearity.structure.StructureManager;
import goat.projectLinearity.structure.GenCheckType;
import goat.projectLinearity.world.sector.*;
import goat.projectLinearity.util.TpsMonitor;
import goat.projectLinearity.world.ConsegrityRegions;
import org.bukkit.Bukkit;
import org.bukkit.entity.Player;
import org.bukkit.event.Listener;
import org.bukkit.plugin.java.JavaPlugin;

public final class ProjectLinearity extends JavaPlugin implements Listener {

    private StructureManager structureManager;
    private TpsMonitor tpsMonitor;
    private volatile boolean regenInProgress = false;

    // Advancement tabs (optional; may remain null). Only used by commands/listeners defensively.
    public AdvancementTab consegrity, desert, mesa, swamp, cherry, mountain, jungle;

    @Override
    public void onEnable() {
        // Commands
        try { getCommand("regenerate").setExecutor(new RegenerateCommand(this)); } catch (Throwable ignored) {}
        try { WarptoCommand warpto = new WarptoCommand(); getCommand("warpto").setExecutor(warpto); getCommand("warpto").setTabCompleter(warpto);} catch (Throwable ignored) {}
        try { getCommand("getallconsegrityadvancements").setExecutor(new GetAllConsegrityAdvancementsCommand(this)); } catch (Throwable ignored) {}

        // Managers
        structureManager = new StructureManager(this);
        // Enable deferred spawner (periodic + on chunk load) to place as you explore
        goat.projectLinearity.structure.DeferredStructureSpawner structSpawner = new goat.projectLinearity.structure.DeferredStructureSpawner(this, structureManager);
        Bukkit.getPluginManager().registerEvents(structSpawner, this);
        Bukkit.getPluginManager().registerEvents(new StructureListener(structureManager), this);
        try { Bukkit.getScheduler().runTaskTimer(this, structSpawner, 1L, 5L); } catch (Throwable ignore) {}

        // TPS monitor
        startTpsMonitor();

        // Register default structures (same tuning as before)
        try {
            structureManager.registerStruct("jungletemple", 24, 10, 100, new JungleSector(), GenCheckType.SURFACE, true, 300);
            structureManager.registerStruct("deserttemple", 30, 4, 200, new DesertBiome(), GenCheckType.SURFACE, true, 300);
            structureManager.registerStruct("witchhut", 10, 10, 100, new SwampSector(), GenCheckType.SURFACE, true, 300);
            structureManager.registerStruct("monastery", 30, 1, 100, new CherrySector(), GenCheckType.SURFACE, true, 300);
        } catch (Throwable ignored) {}
    }

    private void startTpsMonitor() {
        try {
            tpsMonitor = new TpsMonitor();
            Bukkit.getScheduler().runTaskTimer(this, tpsMonitor, 20L, 20L);
        } catch (Throwable ignored) {}
    }

    public StructureManager getStructureManager() { return structureManager; }
    public TpsMonitor getTpsMonitor() { return tpsMonitor; }
    public boolean isRegenInProgress() { return regenInProgress; }
    public void setRegenInProgress(boolean inProgress) { this.regenInProgress = inProgress; }

    // Optional hook used by RegionTitleListener; safe no-op if tabs not initialized
    public void showRegionTab(Player p, ConsegrityRegions.Region r) {
        try {
            AdvancementTab tab = switch (r) {
                case CENTRAL -> consegrity;
                case DESERT -> desert;
                case SAVANNAH -> null; // no dedicated tab available here
                case SWAMP -> swamp;
                case JUNGLE -> jungle;
                case MESA -> mesa;
                case MOUNTAIN -> mountain;
                case ICE_SPIKES -> null;
                case CHERRY -> cherry;
                case OCEAN -> null;
                case NETHER -> null;
            };
            if (tab != null) tab.showTab(p);
        } catch (Throwable ignored) {}
    }
}

